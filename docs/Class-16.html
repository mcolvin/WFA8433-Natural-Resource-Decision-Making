<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title></title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="site_libs/highlight/textmate.css"
      type="text/css" />
<script src="site_libs/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>

<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script src="site_libs/navigation-1.0/tabsets.js"></script>
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.9em;
  padding-left: 5px;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Course home</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Course information
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="index.html">Course home</a>
    </li>
    <li>
      <a href="syllabus.html">Course Syllabus</a>
    </li>
    <li>
      <a href="course-overview.html">Course Overview</a>
    </li>
    <li>
      <a href="final-project.html">About final project</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Classes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Class-01.html">Class 1: Introduction to decision making</a>
    </li>
    <li>
      <a href="Class-02.html">Class 2: The PrOACT Process</a>
    </li>
    <li>
      <a href="Class-03.html">Class 3: Uncertainty and decision making</a>
    </li>
    <li>
      <a href="Class-04.html">Class 4: Decision trees and nets</a>
    </li>
    <li>
      <a href="Class-05.html">Class 5: Intro to SDM and ARM</a>
    </li>
    <li>
      <a href="Class-06.html">Class 6: Structuring and quantifying objectives</a>
    </li>
    <li>
      <a href="Class-07.html">Class 7: Structuring objectives</a>
    </li>
    <li>
      <a href="Class-08.html">Class 8: Intro to R</a>
    </li>
    <li>
      <a href="Class-09.html">Class 9: Linear Models</a>
    </li>
    <li>
      <a href="Class-10.html">Class 10: LMs and GLMs</a>
    </li>
    <li>
      <a href="Class-11.html">Class 11: Prediction and GLMs</a>
    </li>
    <li>
      <a href="Class-12.html">Class 12: GLMs continued</a>
    </li>
    <li>
      <a href="Class-13.html">Class 13: Poissons</a>
    </li>
    <li>
      <a href="Class-14.html">Class 14: HLMs</a>
    </li>
    <li>
      <a href="Class-15.html">Class 15: HLMs and occupancy</a>
    </li>
    <li>
      <a href="Class-16.html">Class 16: Occupancy continued</a>
    </li>
    <li>
      <a href="Class-17.html">Class 17: Influence diagrams &amp; N-Mixtures</a>
    </li>
    <li>
      <a href="Class-18.html">Class 18: Sensitivity analyses &amp; Estimating abundance</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Assignments
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="hw-01.html">Homework 1</a>
    </li>
    <li>
      <a href="hw-02.html">Homework 2</a>
    </li>
    <li>
      <a href="hw-03.html">Homework 3</a>
    </li>
    <li>
      <a href="hw-04.html">Homework 4</a>
    </li>
    <li>
      <a href="hw-05.html">Homework 5</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Additional Resources
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="R-tutorials.html">R tutorials</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<p><!--

library(knitr)
rmarkdown::render_site("Class-16.Rmd")# build website
# rmarkdown::render_site()# build webpage
# COPY FILES TO DOCS FOR GITHUB.IO
system(paste("xcopy",'"C:/Users/mcolvin/Documents/Teaching/WFA8433-Natural-Resource-Decision-Making/Course-Materials/_site"',     '"C:/Users/mcolvin/Documents/Teaching/WFA8433-Natural-Resource-Decision-Making/Docs"',     "/E /C /H /R /K /O /Y")) 
q(save="no") 

rmarkdown::render_site()# build webpage
## PURL R CODE FROM CLASS NOTES
p<- knitr::purl("Class-16.Rmd")
knitr::read_chunk(p)
chunks <- knitr:::knit_code$get()
chunkss<- lapply(1:length(chunks),function(x){if(!(names(chunks[x]) %in% c("echo=FALSE" ,"eval=FALSE"))){c(paste0("## ----", names(chunks)[x] ,"---- ##"),chunks[[x]]," "," "," ")}})
xxx<- unlist(chunkss);
writeLines(xxx,"./scripts/Class-16.R")
system(paste("xcopy",'"C:/Users/mcolvin/Documents/Teaching/WFA8433-Natural-Resource-Decision-Making/Course-Materials/_site"',     '"C:/Users/mcolvin/Documents/Teaching/WFA8433-Natural-Resource-Decision-Making/Docs"',     "/E /C /H /R /K /O /Y")) 

--></p>
<p><img src="media/banner-04.jpg" width="100%" /> <!--
Homework 1:  Introduction to basic computing- R
List of preliminary problems to instructor for review
--></p>
<div id="class-16-occupancy-part-ii" class="section level1 unnumbered">
<h1>Class 16: Occupancy Part II</h1>
</div>
<div id="class-preliminaries" class="section level1">
<h1><span class="header-section-number">1</span> Class preliminaries</h1>
<div id="housekeeping" class="section level2">
<h2><span class="header-section-number">1.1</span> Housekeeping</h2>
<ul>
<li>Dr. Mark Woodrey
<ul>
<li>Guest speaker-last 10 minutes of class</li>
<li>Application of Structured Decision Making to the Development of a Gulf of Mexico-wide Bird Monitoring Program March 10th at 11 am. Tully Auditorium.</li>
</ul></li>
<li>Supplemental background reading(s):
<ul>
<li>Powell and Gale. Chapter 15: Occupancy Modeling <a href="http://media.wix.com/ugd/95e73b_431c4d6ee6c6475d909dc90a766ae185.pdf">here</a></li>
</ul></li>
<li>Assignment due: None</li>
<li>Class project:</li>
<li>Link to class recording <a href="https://youtu.be/3WHdeFJyJkI">YouTube</a></li>
<li>Today’s R script <a href="scripts/Class-16.R">Class-16.R</a></li>
</ul>
</div>
<div id="class-overview-objectives" class="section level2">
<h2><span class="header-section-number">1.2</span> Class overview &amp; objectives</h2>
<p>This class will continue with occupancy estimation using unmarked individuals. We will use a combination of virtual By the end of this class you should be able to:</p>
<ol style="list-style-type: decimal">
<li>Understand the consequences of imperfect detection</li>
<li>simulate occupancy data with imperfect detection</li>
<li>fit an occupancy model with
<ol style="list-style-type: decimal">
<li>homogenous occupancy rates and capture probabilities</li>
<li>homogenous occupancy rates and heterogeneous capture probabilities</li>
<li>heterogeneous occupancy rates and capture probabilities</li>
</ol></li>
<li>Predict occupancy rates for unsampled areas</li>
</ol>
</div>
<div id="getting-ready-to-go" class="section level2">
<h2><span class="header-section-number">1.3</span> Getting ready to go</h2>
<ul>
<li>The R scipt for class can be found <a href="scripts/Class-16.R">here</a></li>
<li>If we get to it there will be one dataset we evaluate <a href="occ-01.csv">here</a></li>
<li>Once you have the script where you want it it where you want open the R script and be sure to check the working directory <code>getwd()</code> and make sure it is where your folder is.</li>
<li>If your working directory is not correct, you can set it in Rstudio: “Session –&gt; Set Working Directory –&gt; To source file location”. Or you can use the <code>setwd()</code> in the console.</li>
</ul>
</div>
</div>
<div id="simulating-occupancy" class="section level1">
<h1><span class="header-section-number">2</span> Simulating occupancy</h1>
<div id="model-and-assumptions" class="section level2">
<h2><span class="header-section-number">2.1</span> Model and assumptions</h2>
<p>Formally, occupancy models have 2 parts a process model (i.e., the model that predicts occupancy) and an observation model (i.e., the model that predicts whether a detection occurs given a critter is there). Formally, the process model (i.e., occupancy) is</p>
<p><span class="math display">\[logit(\psi_i) = \beta_{\psi,0}\]</span></p>
<p>and</p>
<p><span class="math display">\[Z_i \sim Bernoulli(\psi_i)\]</span></p>
<p>where * <span class="math inline">\(\beta_{\psi,0}\)</span> is the intercept (<code>beta_psi_0</code>), * <span class="math inline">\(\psi_i\)</span> is site specific occupancy rate (<code>psi_i</code>), * <span class="math inline">\(Z_i\)</span> is the latent site occupancy status (<code>Z+i</code>), and * <span class="math inline">\(i\)</span> indexes each site sampled (<code>i</code>).</p>
<p>The observation model is</p>
<p><span class="math display">\[logit(p_i) = \beta_{p,0}\]</span></p>
<p>and</p>
<p>$$Y_{i,t} Bernoulli(p_i),</p>
<p>where</p>
<ul>
<li>$Y_{i,t} is the site and occasion specific detection (<code>Y_i_t</code>),</li>
<li><span class="math inline">\(p_i\)</span> is the detection probability (<code>p_i</code>),</li>
<li><span class="math inline">\(i\)</span> indexes each site sampled, and (<code>i</code>) , and</li>
<li><span class="math inline">\(t\)</span> indexes the observation occasion (<code>t</code>).</li>
</ul>
<p>Hopefully that looks familiar from working with GLMs…</p>
<p>Occupancy analysis assumes:</p>
<ol style="list-style-type: decimal">
<li>Closure to change in occupancy status</li>
<li>Occupancy is constant. Can be relaxed with covariates</li>
<li>No false positives (i.e., detections when site is unoccupied)</li>
<li>Surveys and sites are independent</li>
</ol>
<p>See Powell and Gale 2015 for more detailed background of occupancy assumptions.</p>
</div>
<div id="occupancy" class="section level2">
<h2><span class="header-section-number">2.2</span> Occupancy</h2>
<p>Having the skills to simulate the process and observation model will pay big returns, hopefully, because you can further your understanding of how these models work and also how the estimates will predict outcomes. We will simulate some data to further our understanding of occupancy.</p>
</div>
<div id="sampling-frame" class="section level2">
<h2><span class="header-section-number">2.3</span> Sampling frame</h2>
<p>Suppose you have a study area that can be gridded into 300 units. The sampling domain might look like:</p>
<p><img src="Class-16_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>Its good, imagine being lucky enough to have a perfect square for a study area. The cells with points in them represent sites that are randomly sampled from the 324 potential cells.</p>
<p>The code below simulates a dataset with</p>
<ul>
<li><span class="math inline">\(\beta_{\psi,0} = -0.6190392\)</span>(<span class="math inline">\(\psi_i = 0.35\)</span>)</li>
<li>A sampling frame of 324 points (<code>N</code>)</li>
<li>A sample of 35 sites (<code>n</code>)</li>
</ul>
<p>First we need to simulate the population of sites, 324 to be exact. The code below</p>
<pre class="r"><code>N&lt;- 324
n=35
beta_psi_0&lt;- -0.6190392 # set occupancy probability to 0.35
psi_i&lt;- exp(beta_psi_0)/(1+exp(beta_psi_0)) 
psi_i # </code></pre>
<pre><code>## [1] 0.35</code></pre>
<pre class="r"><code>Z_i&lt;- rbinom(N,1,psi_i)
table(Z_i) # should be close to psi_i*N and (1-psi_i)*N</code></pre>
<pre><code>## Z_i
##   0   1 
## 217 107</code></pre>
<pre class="r"><code>mean(Z_i)# should be close to 0.35</code></pre>
<pre><code>## [1] 0.3302469</code></pre>
<p>For clarity lets make the status into a data.frame and number each site.</p>
<pre class="r"><code>sites&lt;- data.frame(id=c(1:N), occupied=Z_i)
# lets look at the first 10 rows of the data.frame
head(sites,10)</code></pre>
<pre><code>##    id occupied
## 1   1        0
## 2   2        1
## 3   3        0
## 4   4        1
## 5   5        0
## 6   6        0
## 7   7        0
## 8   8        0
## 9   9        0
## 10 10        1</code></pre>
<p>Now that we know what our sites are for occupancy status we can sample 35 of them to estimate occupancy! Remember we are assuming that <span class="math inline">\(p=1\)</span> for now! The column “occupied” is the true occupancy status.</p>
<p>No we can sample our entire population, in this case without replacement using the <code>sample()</code> function. If you sampled like we do below with replacement that is a bootstrap replicate (i.e., sample with replacement as many observations as there are in the original dataset).</p>
<pre class="r"><code># the sample function takes a random sample 
# of 35 sites without replacement
n&lt;-35
# does a simple random sample
# by sampling a row number between 1 to N
my_sample&lt;- sample(sites$id, n,replace=FALSE)
# The which() function returns the rows where 
# the condition is true.
my_srs&lt;- sites[which(sites$id %in% my_sample),]# get the samples 
# look at our sites
head(my_srs)</code></pre>
<pre><code>##    id occupied
## 8   8        0
## 14 14        0
## 20 20        0
## 49 49        0
## 64 64        0
## 85 85        0</code></pre>
<p>Now we can do just as we did before, but now we are estimating occupancy.</p>
<pre class="r"><code>table(my_srs$occupied) # should be close to psi*35 and (1-psi)*35</code></pre>
<pre><code>## 
##  0  1 
## 25 10</code></pre>
<pre class="r"><code>mean(my_srs$occupied)# should be close to psi</code></pre>
<pre><code>## [1] 0.2857143</code></pre>
</div>
<div id="perfect-detection" class="section level2">
<h2><span class="header-section-number">2.4</span> Perfect detection</h2>
<p>Recall that <span class="math inline">\(p = 1\)</span>. So if we went out 4 times to the 35 sites we randomly selected the detection history would be 1111 because there is no chance we might miss detecting the critter. But lets prove this using simulation. Keep in mind that it is the site that is occupied so detection is conditional on whether or not a site is occupied. In other words you cannot detect a critter that is not there. This can be confusing… conditional? Hopefully some simulation will clarify this. To simulate this we use the <code>rbinom()</code> function again to simulate 0 and 1 where the 0s and 1s correspond detecting the critter. For this example we will go out on 4 occasions.</p>
<pre class="r"><code>p_i&lt;-1 # homogenous detection prob among sites
# occasion 1
occasion1&lt;- rbinom(35,1,my_srs$occupied*p_i) 
# occasion 2
occasion2&lt;- rbinom(35,1,my_srs$occupied*p_i) 
# occasion 3
occasion3&lt;- rbinom(35,1,my_srs$occupied*p_i) 
# occasion 4
occasion4&lt;- rbinom(35,1,my_srs$occupied*p_i) </code></pre>
<p>Now we can put those together as a matrix of capture histories with each row representing sites and each column representing occasion. The <code>cbind()</code> function glues vectors together that can be made into a <code>matrix</code> or <code>data.frame</code></p>
<pre class="r"><code>detections&lt;- cbind(occasion1,occasion2,occasion3,occasion4)
# lets look at the detections
head(detections)</code></pre>
<pre><code>##      occasion1 occasion2 occasion3 occasion4
## [1,]         0         0         0         0
## [2,]         0         0         0         0
## [3,]         0         0         0         0
## [4,]         0         0         0         0
## [5,]         0         0         0         0
## [6,]         0         0         0         0</code></pre>
<p>The big thing that you will notice above is that there are sites that are all 0s! This is where the conditional detection probability comes in, you cannot detect something that is not there, at least that is what we are assuming!</p>
</div>
<div id="imperfect-detection" class="section level2">
<h2><span class="header-section-number">2.5</span> Imperfect detection</h2>
<p>What happens when <span class="math inline">\(p_i &lt; 1\)</span>? Well we can simulate that too by simply changing <span class="math inline">\(p\)</span> in the r code. Now lets do something extreme and pretend we can only detect the critter if it is there with a probability of 0.20.</p>
<p>Because <span class="math inline">\(p_i\)</span> is less than 1 we can formally express <span class="math inline">\(p_i\)</span> as we did in the observation model above as:</p>
<p><span class="math display">\[logit(p_i) = \beta_{p,0}\]</span></p>
<p>where the parameters are as defined above.</p>
<pre class="r"><code>beta_p_0&lt;- -1.386294 # 0.2 log odds
p_i&lt;-exp(beta_p_0)/(1+exp(beta_p_0))
p_i</code></pre>
<pre><code>## [1] 0.2000001</code></pre>
<p>Now we can generate the capture histories for each of the 4 occasions.</p>
<pre class="r"><code># occasion 1
occasion1&lt;- rbinom(35,1,my_srs$occupied*p_i) 
# occasion 2
occasion2&lt;- rbinom(35,1, my_srs$occupied*p_i) 
# occasion 3
occasion3&lt;- rbinom(35,1, my_srs$occupied*p_i) 
# occasion 4
occasion4&lt;- rbinom(35,1, my_srs$occupied*p_i) 
detections&lt;- cbind(occasion1,occasion2,occasion3,occasion4)
head(detections) # lets look at the detections</code></pre>
<pre><code>##      occasion1 occasion2 occasion3 occasion4
## [1,]         0         0         0         0
## [2,]         0         0         0         0
## [3,]         0         0         0         0
## [4,]         0         0         0         0
## [5,]         0         0         0         0
## [6,]         0         0         0         0</code></pre>
<p>You will see now that there are a lot more 0s in the mix compared to when <span class="math inline">\(p = 1\)</span>! But the one thing that remains that same is that sites where the ‘true’ occupancy status is 0 remain as ‘0000’ but now we may have a few instance where site occupancy = 1 but the detection history is ‘0000’ as well.</p>
<p>We can look at those instances by figuring out by binding the column of occupancy status for each site to the detection history.</p>
<pre class="r"><code>head(cbind(detections, my_srs$occupied))</code></pre>
<pre><code>##      occasion1 occasion2 occasion3 occasion4  
## [1,]         0         0         0         0 0
## [2,]         0         0         0         0 0
## [3,]         0         0         0         0 0
## [4,]         0         0         0         0 0
## [5,]         0         0         0         0 0
## [6,]         0         0         0         0 0</code></pre>
<p>Now you can look at what sites are occupied but the critter was not detected!</p>
</div>
<div id="naive-occupancy-estimates" class="section level2">
<h2><span class="header-section-number">2.6</span> Naive occupancy estimates</h2>
<p>A naive way to estimate occupancy is to determine sites where the critter was detected in 1 or more occasions and use that as an occupancy estimate. Let’s see how that goes here, recall that <span class="math inline">\(\psi = 0.35\)</span> and therefore this naive estimate should be close or else the estimate is biased. We can easily figure out how many detections at each site by using the <code>rowSums()</code> function, which does what it says, sums the rows. Then if you use the <code>ifelse()</code> function to say if a value is greater than 0 then make it 1 and if not then 0. Then if you take the average of the 0s and 1s you get the naive estimate of occupancy.</p>
<pre class="r"><code>no_detections&lt;- rowSums(detections)# how many detections
occupied&lt;- ifelse(no_detections&gt;0,1,0) # assign sites as occupied or not
mean(occupied) # close to 0.35?</code></pre>
<pre><code>## [1] 0.08571429</code></pre>
<p>Well that 0.0857143 is not equal to 0.35! In fact that is the whole reason for occupancy models, occupancy estimates are <em>underestimated</em> if <span class="math inline">\(p &lt; 1\)</span>!</p>
<p>Imagine if you had only done 1 occasion, the estimated occupancy would have been 0.0285714 which is even worse! This is what happens most of the time, single occasions, so lets explore the consequences of this on estimated occupancy.</p>
</div>
<div id="effects-of-imperfect-detection" class="section level2">
<h2><span class="header-section-number">2.7</span> Effects of imperfect detection</h2>
<p>Let’s explore this for a range of <span class="math inline">\(p_i\)</span> from 0.1 to 1 to examine that effect, assuming detection probability is homogenous among sites. Recall that <span class="math inline">\(\psi= 0.35\)</span>.</p>
<pre class="r"><code>beta_psi_0&lt;- -0.6190392 # set occupancy probability to 0.35
psi_i&lt;- exp(beta_psi_0)/(1+exp(beta_psi_0)) 
psi_i # </code></pre>
<pre><code>## [1] 0.35</code></pre>
<p>Now we can set our values for <span class="math inline">\(p\)</span>. We will forgo using the <span class="math inline">\(\beta\)</span> and log odds and simply specify the probability for ease. Plus we can easily loop over the values of p to rapidly evaluate the effect of imperfect detection.</p>
<pre class="r"><code>p_i&lt;- seq(0.1,1,0.1)
p_i</code></pre>
<pre><code>##  [1] 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0</code></pre>
<p>Now we can loop over <span class="math inline">\(p_i\)</span> to get an estimate of occupancy and the consequences of assuming perfect detection using our 35 sites.</p>
<pre class="r"><code># define object to save the naive 
# occupancy estimates
output&lt;- data.frame(p_i=p_i,
    occupancy_est=NA)
for(i in 1:length(p_i))
    {
    # OBSERVATION 1 OF ALL 35 SITES
    occasion1&lt;- rbinom(n,1,psi_i*p_i[i])
    output$occupancy_est[i]&lt;- mean(occasion1)
    }    </code></pre>
<p>And we can look at them.</p>
<pre class="r"><code>plot(occupancy_est~p_i,
    data=output,
    xlab=&quot;Detection probability&quot;,
    ylab=&quot;Estimated occupancy&quot;)</code></pre>
<p><img src="Class-16_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p>Well that plot is sort of clean. This is a stochastic process so we should do many simulations for each value of <span class="math inline">\(p_i\)</span> we evaluate. Let’s do that. First we will make a matrix to hold all of our outputs.</p>
<pre class="r"><code># define matrix to save outputs to for 1000 replicates
occupancy_est&lt;- matrix(NA,nrow=1000,ncol=length(p_i)) </code></pre>
<p>Now we can loop over each <span class="math inline">\(p_i\)</span> and then perform 1000 stochastic replicates in the inner loop.</p>
<pre class="r"><code>for(i in 1:length(p_i)) #loop over p
    {
    for(rep in 1:1000) # do 1000 stochastic replicates
        {
        # simulate observations
        occasion1&lt;- rbinom(35,1,psi_i*p_i[i]) 
        # calculate naive occupancy
        occupancy_est[rep,i]&lt;-mean(occasion1)
        }
    }</code></pre>
<p>Now we can plot the replicates by each value of <span class="math inline">\(p_i\)</span> we evaluated.</p>
<pre class="r"><code>boxplot(occupancy_est,
    xlab=&quot;Detection probability&quot;,
    ylab=&quot;Estimated occupancy&quot;,
    names=p_i) # name the x axis as the values of p
# add a line for the true value of psi
abline(h=psi_i,lty=2) </code></pre>
<p><img src="Class-16_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p><em>So, as you can see from the boxplots occupancy estimates are negatively biased when <span class="math inline">\(p &lt; 1\)</span>!</em> So it makes good sense to account for imperfect detection.</p>
</div>
<div id="accounting-for-imperfect-detection" class="section level2">
<h2><span class="header-section-number">2.8</span> Accounting for imperfect detection</h2>
<p>Occupancy models estimate both <span class="math inline">\(\psi_i\)</span> and <span class="math inline">\(p_i\)</span> from detection histories assuming that <span class="math inline">\(p_i\)</span> is the conditional capture probability. Let’s see how an occupancy model for <span class="math inline">\(p_i = 0.3\)</span> works!</p>
<p>Let’s simulate our detection histories from our original random sample. Remember the data we simulated in <code>my_srs</code>?</p>
<pre class="r"><code>beta_p_0&lt;- -0.8472979 # set p to 0.3
p_i&lt;- exp(beta_p_0)/(1+exp(beta_p_0)) 
p_i # </code></pre>
<pre><code>## [1] 0.3</code></pre>
<pre class="r"><code>occasion1&lt;- rbinom(35,1,my_srs$occupied*p_i) 
occasion2&lt;- rbinom(35,1, my_srs$occupied*p_i) 
occasion3&lt;- rbinom(35,1, my_srs$occupied*p_i) 
occasion4&lt;- rbinom(35,1, my_srs$occupied*p_i) 
detections&lt;- cbind(occasion1,occasion2,occasion3,occasion4)
head(detections) # lets look at the detections</code></pre>
<pre><code>##      occasion1 occasion2 occasion3 occasion4
## [1,]         0         0         0         0
## [2,]         0         0         0         0
## [3,]         0         0         0         0
## [4,]         0         0         0         0
## [5,]         0         0         0         0
## [6,]         0         0         0         0</code></pre>
<p>Ok, looks great, some 1s but mostly 0s.</p>
<p>Now lets fit an occupancy model to the data. First we need the unmarked package to do so.</p>
<pre class="r"><code>#install.packages(&quot;unmarked&quot;)
library(unmarked)</code></pre>
<p>Now we need to get our detections into a matrix for unmarked.</p>
<pre class="r"><code>detections&lt;-  unmarkedFrameOccu(detections, 
    siteCovs=NULL, 
    obsCovs=NULL)
head(detections)</code></pre>
<pre><code>## Data frame representation of unmarkedFrame object.
##    y.1 y.2 y.3 y.4
## 1    0   0   0   0
## 2    0   0   0   0
## 3    0   0   0   0
## 4    0   0   0   0
## 5    0   0   0   0
## 6    0   0   0   0
## 7    0   0   0   0
## 8    0   1   0   1
## 9    1   0   0   0
## 10   0   0   0   0</code></pre>
<p>Note we do not have any site or observation covariates at this point and therefore they are NULL.</p>
<p>Now we can fit an occupancy model. Note that in the model equation the first tilda is for occupancy and the second is for detection. This becomes important once you are using covariates.</p>
<pre class="r"><code>fit &lt;- occu(~ 1 ~ 1, detections)
fit</code></pre>
<pre><code>## 
## Call:
## occu(formula = ~1 ~ 1, data = detections)
## 
## Occupancy:
##  Estimate    SE     z P(&gt;|z|)
##     -1.22 0.459 -2.65 0.00796
## 
## Detection:
##  Estimate   SE     z P(&gt;|z|)
##    -0.377 0.46 -0.82   0.412
## 
## AIC: 76.22952</code></pre>
<p>Well crappola, that does not make much sense, <span class="math inline">\(p\)</span> was 0.2 and <span class="math inline">\(\psi\)</span> was 0.35 but the estimates are -1.2181207 for occupancy and -0.3772526 for detection probability.</p>
<p>We can extract the estimates from the fitted model as:</p>
<pre class="r"><code>coef(fit)[1]# occupancy</code></pre>
<pre><code>##  psi(Int) 
## -1.218121</code></pre>
<pre class="r"><code>coef(fit)[2]# detection</code></pre>
<pre><code>##     p(Int) 
## -0.3772526</code></pre>
<p>As is the case with most binary (0,1) data the linear models use a logit transformation and this estimates are on logit scale. If we want the actual values we need to simple take the estimate and run in through the equation <span class="math inline">\(exp(est)/(1+exp(est))\)</span></p>
<pre class="r"><code>occ_est_lo&lt;- coef(fit)[1]# occupancy logit
exp(occ_est_lo)/(1+exp(occ_est_lo)) # it is close to 0.35!</code></pre>
<pre><code>##  psi(Int) 
## 0.2282673</code></pre>
<pre class="r"><code>det_est_lo&lt;- coef(fit)[2]# detection logit
exp(det_est_lo)/(1+exp(det_est_lo)) # it is close to 0.2!</code></pre>
<pre><code>##    p(Int) 
## 0.4067897</code></pre>
<p>Fortunately unmarked can do that for you as well.</p>
<pre class="r"><code># back transform occupancy
backTransform(fit, type=&quot;state&quot;)</code></pre>
<pre><code>## Backtransformed linear combination(s) of Occupancy estimate(s)
## 
##  Estimate     SE LinComb (Intercept)
##     0.228 0.0809   -1.22           1
## 
## Transformation: logistic</code></pre>
<pre class="r"><code># back transform detection probability
backTransform(fit, type=&quot;det&quot;)</code></pre>
<pre><code>## Backtransformed linear combination(s) of Detection estimate(s)
## 
##  Estimate    SE LinComb (Intercept)
##     0.407 0.111  -0.377           1
## 
## Transformation: logistic</code></pre>
</div>
</div>
<div id="covariates-and-detection-probability" class="section level1">
<h1><span class="header-section-number">3</span> Covariates and detection probability</h1>
<p>Now we can relax the assumption that detection probability is heterogeneous. Heterogeneity might arise because of weather variation among occasions, variation among observers, habitat variability and so on. In this section we will assuming heterogeneous capture probabilities that are related a covariate <span class="math inline">\(X_i\)</span> that varies among site <span class="math inline">\(i\)</span>. Formally, the process model (i.e., occupancy) remains the same as above and is</p>
<p><span class="math display">\[logit(\psi_i) = \beta_{\psi,0}\]</span></p>
<p>and</p>
<p><span class="math display">\[Z_i \sim Bernoulli(\psi_i)\]</span></p>
<p>where the parameters are as defined above. The observation model is modified so that there is now an effect of a covariate on detection probility.</p>
<p><span class="math display">\[logit(p_i) = \beta_{p,0}+\beta_{p,1}\cdot X_i\]</span></p>
<p>and</p>
<p>$$Y_{i,t} Bernoulli(p_i),</p>
<p>where the parameters are as defined above but we have a new parameter <span class="math inline">\(\beta_{p,1}\)</span> which is the effect of covariate <span class="math inline">\(X\)</span> on detection probability. Let’s put our simulation skills to the test and see if we can simulate the from process and observation models. First we need to simulate the occupancy process. Let’s use the same data we simulated above, <code>my_srs</code> for this section.</p>
<pre class="r"><code>head(my_srs)# the true occupancy</code></pre>
<pre><code>##    id occupied
## 8   8        0
## 14 14        0
## 20 20        0
## 49 49        0
## 64 64        0
## 85 85        0</code></pre>
<p>Now let’s specify a relationship between a detection probability and a covariate <span class="math inline">\(X\)</span>.</p>
<pre class="r"><code>beta_p_0&lt;- -0.8472979 # set p to 0.3
beta_p_1&lt;- -0.02 #
my_srs$X&lt;- runif(n,0,100)
# log odds detection probability
my_srs$lo_p_i&lt;- beta_p_0+beta_p_1*my_srs$X
# detection probability
my_srs$p_i&lt;-exp(my_srs$lo_p_i)/(1+exp(my_srs$lo_p_i))</code></pre>
<p>There we have a detection probability that varies among sites as a function of <span class="math inline">\(X_i\)</span>. Let’s take a look.</p>
<pre class="r"><code>plot(p_i~X,my_srs,
    xlab=&quot;Covariate X&quot;,
    ylab=&quot;Detection probability&quot;)</code></pre>
<p><img src="Class-16_files/figure-html/unnamed-chunk-29-1.png" width="672" /> Looks like detection probability declines with <span class="math inline">\(X_i\)</span>. Now we can do just as we did before and simulate the observations.</p>
<pre class="r"><code>occasion1&lt;- rbinom(35,1,my_srs$occupied*p_i) 
occasion2&lt;- rbinom(35,1, my_srs$occupied*p_i) 
occasion3&lt;- rbinom(35,1, my_srs$occupied*p_i) 
occasion4&lt;- rbinom(35,1, my_srs$occupied*p_i) 
detections&lt;- cbind(occasion1,occasion2,occasion3,occasion4)
head(detections) # lets look at the detections</code></pre>
<pre><code>##      occasion1 occasion2 occasion3 occasion4
## [1,]         0         0         0         0
## [2,]         0         0         0         0
## [3,]         0         0         0         0
## [4,]         0         0         0         0
## [5,]         0         0         0         0
## [6,]         0         0         0         0</code></pre>
<p>Now we can format the data and the covariates for analysis. first we need to make the covariates a <code>data.frame</code>.</p>
<pre class="r"><code>site_covs&lt;- my_srs</code></pre>
<p>Now we can make the unmarked <code>data.frame</code> needed for analysis.</p>
<pre class="r"><code>detections&lt;-  unmarkedFrameOccu(y=detections, 
    siteCovs=site_covs, 
    obsCovs=NULL)
head(detections)</code></pre>
<pre><code>## Data frame representation of unmarkedFrame object.
##     y.1 y.2 y.3 y.4  id occupied        X    lo_p_i        p_i
## 8     0   0   0   0   8        0 23.43288 -1.315956 0.21149197
## 14    0   0   0   0  14        0 39.07438 -1.628785 0.16399681
## 20    0   0   0   0  20        0 67.89378 -2.205174 0.09928686
## 49    0   0   0   0  49        0 49.62402 -1.839778 0.13707752
## 64    0   0   0   0  64        0 24.09151 -1.329128 0.20930362
## 85    0   0   0   0  85        0 13.67836 -1.120865 0.24585086
## 90    0   0   0   0  90        0 61.10899 -2.069478 0.11209901
## 99    0   0   1   0  99        1 87.14266 -2.590151 0.06977497
## 101   0   1   0   0 101        1 26.31078 -1.373513 0.20205279
## 105   0   0   0   0 105        0 36.71124 -1.581523 0.17057993</code></pre>
<p>Note we do not have any site or observation covariates at this point and therefore they are NULL.</p>
<p>Now we can fit an occupancy model. Note that in the model equation the first tilda is for detection and the second is for occupancy. We can specify the covariate for detection probability.</p>
<pre class="r"><code>fit &lt;- occu(~ X ~ 1, detections)
fit</code></pre>
<pre><code>## 
## Call:
## occu(formula = ~X ~ 1, data = detections)
## 
## Occupancy:
##  Estimate   SE      z P(&gt;|z|)
##    -0.469 0.65 -0.721   0.471
## 
## Detection:
##              Estimate     SE       z P(&gt;|z|)
## (Intercept) -1.161188 1.2011 -0.9668   0.334
## X            0.000273 0.0164  0.0166   0.987
## 
## AIC: 88.32565</code></pre>
<p>We can extract the estimates from the fitted model as:</p>
<pre class="r"><code>coef(fit)[1]# occupancy</code></pre>
<pre><code>##   psi(Int) 
## -0.4687775</code></pre>
<pre class="r"><code>coef(fit)[2]# detection</code></pre>
<pre><code>##    p(Int) 
## -1.161188</code></pre>
<p>As is the case with most binary (0,1) data the linear models use a logit transformation and this estimates are on logit scale. If we want the actual values we need to simple take the estimate and run in through the equation <span class="math inline">\(exp(est)/(1+exp(est))\)</span></p>
<pre class="r"><code>occ_est_lo&lt;- coef(fit)[1]# occupancy logit
exp(occ_est_lo)/(1+exp(occ_est_lo)) </code></pre>
<pre><code>##  psi(Int) 
## 0.3849056</code></pre>
<pre class="r"><code>det_est_lo&lt;- coef(fit)[2]# detection logit
exp(det_est_lo)/(1+exp(det_est_lo)) </code></pre>
<pre><code>##    p(Int) 
## 0.2384515</code></pre>
</div>
<div id="covariates-and-occupancy" class="section level1">
<h1><span class="header-section-number">4</span> Covariates and occupancy</h1>
<p>Now we can add a covariate to occupancy and detection. Suppose we have a sampling domain that looks like the figure below.</p>
<pre><code>## Warning: package &#39;reshape2&#39; was built under R version 3.1.3</code></pre>
<pre><code>## 
## Attaching package: &#39;reshape2&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:reshape&#39;:
## 
##     colsplit, melt, recast</code></pre>
<p><img src="Class-16_files/figure-html/unnamed-chunk-36-1.png" width="672" /> The data for the domain above can be read in as below.</p>
<pre class="r"><code>dat&lt;- read.csv(&quot;occ-01.csv&quot;)</code></pre>
<p>The increasing blue intensity represents increasing depth. Within the polygon above the true occupancy of a critter is related to depth. Specifically, the occupancy decreases with depth.</p>
<pre class="r"><code>beta_psi_0&lt;- 1.1 
beta_psi_1&lt;- -0.35 #

# log odds occupancy
dat$lo_psi_i&lt;- beta_psi_0+beta_psi_1*dat$depth
# detection probability
dat$psi_i&lt;-exp(dat$lo_psi_i)/(1+exp(dat$lo_psi_i))</code></pre>
<p>And we plot the relationship of <span class="math inline">\(\psi_i\)</span> to get a sense for what is going on.</p>
<pre class="r"><code>plot(psi_i~depth,
    data=dat,
    xlab=&quot;Depth&quot;,
    ylab=&quot;Occupancy&quot;)</code></pre>
<p><img src="Class-16_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
<p>And we can simulate whether a site is occupied or not.</p>
<pre class="r"><code>N&lt;- nrow(dat)
dat$occupancy&lt;- rbinom(N,1,dat$psi_i)</code></pre>
<p>Suppose can sample 40 sites (<code>n</code>) out of the 524 possible sites (<code>N</code>). That would look like the image below.</p>
<p>Note that this approach was a bit different then the approach above that we used the <code>which()</code> statement. If we wanted to plot the data above we can plot x,y, data with z data, depth in this case using the <code>image.plot()</code> function within the fields package.</p>
<pre class="r"><code>#install.packages(&quot;fields&quot;)
library(fields)</code></pre>
<pre><code>## Warning: package &#39;fields&#39; was built under R version 3.1.3</code></pre>
<pre><code>## Loading required package: spam</code></pre>
<pre><code>## Warning: package &#39;spam&#39; was built under R version 3.1.3</code></pre>
<pre><code>## Loading required package: grid</code></pre>
<pre><code>## Spam version 1.3-0 (2015-10-24) is loaded.
## Type &#39;help( Spam)&#39; or &#39;demo( spam)&#39; for a short introduction 
## and overview of this package.
## Help for individual functions is also obtained by adding the
## suffix &#39;.spam&#39; to the function name, e.g. &#39;help( chol.spam)&#39;.</code></pre>
<pre><code>## 
## Attaching package: &#39;spam&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:unmarked&#39;:
## 
##     mle</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     backsolve, forwardsolve</code></pre>
<pre><code>## Loading required package: maps</code></pre>
<pre><code>## Warning: package &#39;maps&#39; was built under R version 3.1.3</code></pre>
<pre><code>## 
##  # maps v3.1: updated &#39;world&#39;: all lakes moved to separate new #
##  # &#39;lakes&#39; database. Type &#39;?world&#39; or &#39;news(package=&quot;maps&quot;)&#39;.  #</code></pre>
<pre class="r"><code>library(reshape2)
depths&lt;- dcast(dat,x~y,value.var=&quot;depth&quot;)
x&lt;-depths[,1]
y&lt;-as.numeric(names(depths[-1]))
depths&lt;- as.matrix(depths[,-1])
image.plot(x,y,depths,xlim=c(0,7),xlab=&quot;X&quot;,
    ylab=&quot;Y&quot;,
    ylim=c(0,9), 
    col=rainbow(n=20,start=3/6,end=4/6),
    asp=1)  
points(y~x,sampleSites, pch=3,col=&quot;black&quot;,
    cex=0.6)
legend(&quot;topleft&quot;,legend=&quot;Sample Site&quot;,pch=3,bty=&#39;n&#39;)</code></pre>
<p><img src="Class-16_files/figure-html/unnamed-chunk-42-1.png" width="672" /></p>
<div id="occupancy-1" class="section level2">
<h2><span class="header-section-number">4.1</span> Occupancy</h2>
<p>Given the occupancy rates we can simulate the occupancy status for the habitat above.</p>
<p>Let’s get a better feel for what is going down here.</p>
<pre class="r"><code># create new plot of depths
image.plot(x,y,depths,xlim=c(0,7),xlab=&quot;X&quot;,
    ylab=&quot;Y&quot;,
    ylim=c(0,9), 
    col=rainbow(n=20,start=3/6,end=4/6),
    asp=1)  
points(y~x,
    data=dat, 
    pch=1,
    col=&quot;red&quot;,
    cex=0.6,
    subset=occupancy==1)
points(y~x,
    data=dat, 
    pch=1,
    col=&quot;blue&quot;,
    cex=0.6,
    subset=occupancy==0)    
legend(&quot;topleft&quot;,
    legend=c(&quot;Occupied&quot;,&quot;Unoccupied&quot;),
    pch=1,
    col=c(&quot;red&quot;,&quot;blue&quot;),
    bty=&#39;n&#39;)</code></pre>
<p><img src="Class-16_files/figure-html/unnamed-chunk-43-1.png" width="672" /> The true occupancy is the mean of each site.</p>
<pre class="r"><code>true_occ&lt;- mean(dat$occupancy)
true_occ</code></pre>
<pre><code>## [1] 0.5935115</code></pre>
<p>But it varies by depth so the true abundance is a bit tough to interpret.</p>
</div>
<div id="generate-capture-histories" class="section level2">
<h2><span class="header-section-number">4.2</span> Generate capture histories</h2>
<p>The code below generates detections at 20 sites over 5 occasions given the abundance at the site and a capture probability that is also related to depth.</p>
<pre class="r"><code>beta_p_0&lt;- -0.8472979 # set p to 0.3
beta_p_1&lt;- 8.8 #
# log odds detection probability
sampleSites$lo_p_i&lt;- beta_p_0+beta_p_1*sampleSites$velocity
# detection probability
sampleSites$p_i&lt;-exp(sampleSites$lo_p_i)/(1+exp(sampleSites$lo_p_i))</code></pre>
<p>And we can look at the detection probabilities.</p>
<pre class="r"><code>plot(p_i~velocity,
    data=sampleSites,
    xlab=&quot;Velocity&quot;,
    ylab=&quot;Capture probability&quot;)</code></pre>
<p><img src="Class-16_files/figure-html/unnamed-chunk-46-1.png" width="672" /></p>
<p>And now that we have that we can simulate the detection history matrix assuming we go out 5 times to each site.</p>
<pre class="r"><code># GENERATE CAPTURE HISTORIES
nocc&lt;-5
Y_i_t&lt;- matrix(0,n,nocc)
for(i in 1:nocc)
    {
    # FILL EACH ROW WITH DETECTIONS [0,1]
    Y_i_t[,i]&lt;- rbinom(n,1,sampleSites$p_i*sampleSites$occupancy)
    }</code></pre>
<p>The simulated catch at each of the 40 sites for 5 occasions is shown below.</p>
<pre><code>##      [,1] [,2] [,3] [,4] [,5]
## [1,]    0    0    0    0    0
## [2,]    0    0    0    0    0
## [3,]    0    0    0    0    0
## [4,]    0    0    0    0    0
## [5,]    0    0    0    0    0
## [6,]    1    1    1    1    1</code></pre>
<p>Now we can work our magic and fit the occupancy model that relates occupancy and detection to depth.</p>
<pre class="r"><code>site_covs&lt;- sampleSites</code></pre>
<p>Now we can make the unmarked <code>data.frame</code> needed for analysis.</p>
<pre class="r"><code>detections&lt;-  unmarkedFrameOccu(y=Y_i_t, 
    siteCovs=site_covs, 
    obsCovs=NULL)
head(detections)</code></pre>
<pre><code>## Data frame representation of unmarkedFrame object.
##     y.1 y.2 y.3 y.4 y.5   x   y siteId      depth   velocity   lo_psi_i
## 226   0   0   0   0   0 4.6 3.4    226 0.30305009 0.32876857  0.9939325
## 313   0   0   0   0   0 3.6 4.6    313 3.55469886 0.10402062 -0.1441446
## 341   0   0   0   0   0 3.6 5.0    341 4.22943150 0.05040558 -0.3803010
## 18    0   0   0   0   0 1.2 1.0     18 1.67388788 0.14848681  0.5141392
## 82    0   0   0   0   0 2.2 1.8     82 4.35373368 0.03000333 -0.4238068
## 117   1   1   1   1   1 2.4 2.2    117 4.22943150 0.41297257 -0.3803010
## 21    1   0   1   1   1 1.8 1.0     21 4.35373368 0.33358020 -0.4238068
## 115   0   0   0   0   0 2.0 2.2    115 2.51098694 0.38320440  0.2211546
## 45    1   1   1   1   1 5.0 1.2     45 0.03257354 0.41867716  1.0885993
## 95    1   1   1   1   1 5.0 1.8     95 0.05029941 0.23033285  1.0823952
##         psi_i occupancy      lo_p_i       p_i
## 226 0.7298640         0  2.04586553 0.8855292
## 313 0.4640261         0  0.06808358 0.5170143
## 341 0.4060543         0 -0.40372876 0.4004168
## 18  0.6257763         0  0.45938606 0.6128685
## 82  0.3956062         0 -0.58326862 0.3581808
## 117 0.4060543         1  2.78686067 0.9419617
## 21  0.3956062         1  2.08820783 0.8897517
## 115 0.5550644         0  2.52490078 0.9258691
## 45  0.7481179         1  2.83706109 0.9446460
## 95  0.7469470         1  1.17963115 0.7648815</code></pre>
<p>And we can fit the occupancy model.</p>
<pre class="r"><code>fit &lt;- occu(~ velocity ~ depth, detections)
fit</code></pre>
<pre><code>## 
## Call:
## occu(formula = ~velocity ~ depth, data = detections)
## 
## Occupancy:
##             Estimate    SE      z P(&gt;|z|)
## (Intercept)    0.469 0.533  0.881   0.378
## depth         -0.325 0.232 -1.399   0.162
## 
## Detection:
##             Estimate    SE     z  P(&gt;|z|)
## (Intercept)    -1.16 0.562 -2.07 3.88e-02
## velocity       10.04 2.481  4.05 5.22e-05
## 
## AIC: 144.5498</code></pre>
<p>Now the fun thing is that you can predict the occupancy rate back to the sampling frame. We can extract the coefficients using the <code>coef()</code> function and then use our understanding of linear models to generate the predictions.</p>
<pre class="r"><code>betas&lt;- coef(fit)
dat$pred_lo_psi&lt;- betas[1] + betas[2]*dat$depth
dat$psi_hat_i&lt;- exp(dat$pred_lo_psi)/(1+exp(dat$pred_lo_psi))</code></pre>
<p>And we can plot and compare.</p>
<pre class="r"><code>par(mfrow=c(1,2),oma=c(1,2,1,2))

# TRUE PSI
psi_true&lt;- dcast(dat,x~y,value.var=&quot;psi_i&quot;)
x&lt;-psi_true[,1]
y&lt;-as.numeric(names(psi_true[-1]))
psi_true&lt;- as.matrix(psi_true[,-1])
image.plot(x=x,
    y=y,
    z=psi_true,
    xlim=c(0,7),
    breaks=seq(0,1,0.1),
    xlab=&quot;X&quot;,
    ylab=&quot;Y&quot;,
    ylim=c(0,9), 
    col=rainbow(n=10,start=3/6,end=4/6),
    asp=1)  
# ESTIMATED PSI
psi_est&lt;- dcast(dat,x~y,value.var=&quot;psi_hat_i&quot;)
x&lt;-psi_est[,1]
y&lt;-as.numeric(names(psi_est[-1]))
psi_est&lt;- as.matrix(psi_est[,-1])
image.plot(x=x,
    y=y,
    z=psi_est,
    xlim=c(0,7),
    breaks=seq(0,1,0.1),
    xlab=&quot;X&quot;,
    ylab=&quot;Y&quot;,
    ylim=c(0,9), 
    col=rainbow(n=10,start=3/6,end=4/6),
    asp=1)</code></pre>
<p><img src="Class-16_files/figure-html/unnamed-chunk-53-1.png" width="672" /></p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
